# NanoGrid Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    AWS Cloud                                         │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────────┐ │
│  │                        Region: ap-northeast-2 (Seoul)                          │ │
│  │                                                                                │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐  │ │
│  │  │                    Regional Services (Multi-AZ 자동 복제)                │  │ │
│  │  │                                                                         │  │ │
│  │  │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                  │  │ │
│  │  │   │     S3      │   │     SQS     │   │  DynamoDB   │                  │  │ │
│  │  │   │ nanogrid-   │   │ nanogrid-   │   │ NanoGrid-   │                  │  │ │
│  │  │   │ code-bucket │   │ task-queue  │   │ Functions   │                  │  │ │
│  │  │   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘                  │  │ │
│  │  │          │                 │                 │                          │  │ │
│  │  │          └────────────┬────┴─────────────────┘                          │  │ │
│  │  │                       │ VPC Endpoints                                   │  │ │
│  │  └───────────────────────┼─────────────────────────────────────────────────┘  │ │
│  │                          │                                                     │ │
│  │  ┌───────────────────────┼─────────────────────────────────────────────────┐  │ │
│  │  │                       │     VPC: nanogrid-vpc (10.0.0.0/16)              │  │ │
│  │  │                       │                                                  │  │ │
│  │  │  ┌────────────────────┴──────────────────────────────────────────────┐  │  │ │
│  │  │  │                  Availability Zone: ap-northeast-2a                │  │  │ │
│  │  │  │                                                                    │  │  │ │
│  │  │  │  ┌──────────────────────────────────────────────────────────────┐ │  │  │ │
│  │  │  │  │           Public Subnet (10.0.1.0/24)                        │ │  │  │ │
│  │  │  │  │                                                              │ │  │  │ │
│  │  │  │  │   ┌─────────────┐         ┌─────────────┐                   │ │  │  │ │
│  │  │  │  │   │   Internet  │         │     NAT     │                   │ │  │  │ │
│  │  │  │  │   │   Gateway   │         │   Gateway   │                   │ │  │  │ │
│  │  │  │  │   └──────┬──────┘         └──────┬──────┘                   │ │  │  │ │
│  │  │  │  │          │                       │                          │ │  │  │ │
│  │  │  │  └──────────┼───────────────────────┼──────────────────────────┘ │  │  │ │
│  │  │  │             │                       │                            │  │  │ │
│  │  │  │  ┌──────────┼───────────────────────┼──────────────────────────┐ │  │  │ │
│  │  │  │  │          │  Private-App Subnet (10.0.10.0/24)               │ │  │  │ │
│  │  │  │  │          │                       │                          │ │  │  │ │
│  │  │  │  │          │    ┌─────────────────────────────────┐           │ │  │  │ │
│  │  │  │  │          │    │         Lambda Functions        │           │ │  │  │ │
│  │  │  │  │          │    │  ┌───────────┐ ┌─────────────┐  │           │ │  │  │ │
│  │  │  │  │          │    │  │ Resource  │ │ Dispatcher  │  │           │ │  │  │ │
│  │  │  │  │          │    │  │ Manager   │ │   Lambda    │  │           │ │  │  │ │
│  │  │  │  │          │    │  └─────┬─────┘ └──────┬──────┘  │           │ │  │  │ │
│  │  │  │  │          │    └────────┼──────────────┼─────────┘           │ │  │  │ │
│  │  │  │  │          │             │              │                     │ │  │  │ │
│  │  │  │  └──────────┼─────────────┼──────────────┼─────────────────────┘ │  │  │ │
│  │  │  │             │             │              │                       │  │  │ │
│  │  │  │  ┌──────────┼─────────────┼──────────────┼─────────────────────┐ │  │  │ │
│  │  │  │  │          │  Private-Data Subnet (10.0.20.0/24)              │ │  │  │ │
│  │  │  │  │          │             │              │                     │ │  │  │ │
│  │  │  │  │          │    ┌────────┴──────────────┴────────┐            │ │  │  │ │
│  │  │  │  │          │    │                                │            │ │  │  │ │
│  │  │  │  │   ┌──────┴────┴───┐              ┌─────────────┴──┐         │ │  │  │ │
│  │  │  │  │   │  ElastiCache  │              │  EC2 Workers   │         │ │  │  │ │
│  │  │  │  │   │    (Redis)    │◄────────────►│  (ASG: 1~5대)  │         │ │  │  │ │
│  │  │  │  │   │  nanogrid-    │              │  ┌──────────┐  │         │ │  │  │ │
│  │  │  │  │   │  redis        │              │  │ Docker   │  │         │ │  │  │ │
│  │  │  │  │   └───────────────┘              │  │Container │  │         │ │  │  │ │
│  │  │  │  │                                  │  └──────────┘  │         │ │  │  │ │
│  │  │  │  │                                  └────────────────┘         │ │  │  │ │
│  │  │  │  │                                                             │ │  │  │ │
│  │  │  │  └─────────────────────────────────────────────────────────────┘ │  │  │ │
│  │  │  │                                                                  │  │  │ │
│  │  │  └──────────────────────────────────────────────────────────────────┘  │  │ │
│  │  │                                                                        │  │ │
│  │  └────────────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                              │ │
│  │  ┌────────────────────────────────────────────────────────────────────────┐  │ │
│  │  │                         API Gateway (Regional)                         │  │ │
│  │  │                                                                        │  │ │
│  │  │   Endpoint: https://csxdfxv38j.execute-api.ap-northeast-2.amazonaws.com│  │ │
│  │  │                                                                        │  │ │
│  │  │   Routes:                                                              │  │ │
│  │  │   ├── POST /functions  ──────► Resource Manager Lambda                 │  │ │
│  │  │   ├── GET  /functions/{id} ──► Resource Manager Lambda                 │  │ │
│  │  │   ├── DELETE /functions/{id} ► Resource Manager Lambda                 │  │ │
│  │  │   └── POST /run ─────────────► Dispatcher Lambda                       │  │ │
│  │  │                                                                        │  │ │
│  │  └────────────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                              │ │
│  │  ┌────────────────────────────────────────────────────────────────────────┐  │ │
│  │  │                         CloudWatch (Monitoring)                        │  │ │
│  │  │                                                                        │  │ │
│  │  │   Alarms:                                                              │  │ │
│  │  │   ├── SQS Messages ≥ 10 ──► Scale Out (EC2 +1)                        │  │ │
│  │  │   └── SQS Messages = 0  ──► Scale In  (EC2 -1)                        │  │ │
│  │  │                                                                        │  │ │
│  │  └────────────────────────────────────────────────────────────────────────┘  │ │
│  │                                                                              │ │
│  └──────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────┘
                                        ▲
                                        │ HTTPS
                                        │
                                   ┌────┴────┐
                                   │  User   │
                                   │(Client) │
                                   └─────────┘
```

## 데이터 흐름

### 1. 함수 등록 (Deploy)
```
User ──POST /functions──► API Gateway ──► Resource Manager Lambda
                                              │
                                              ├──► S3 (코드 업로드)
                                              └──► DynamoDB (메타데이터 저장)
```

### 2. 함수 실행 (Run)
```
User ──POST /run──► API Gateway ──► Dispatcher Lambda
                                        │
                                        ├──► DynamoDB (메타데이터 조회)
                                        ├──► SQS (작업 등록)
                                        └──► Redis (결과 대기)
                                                  ▲
                                                  │
EC2 Worker ◄── SQS (작업 가져오기)                │
    │                                             │
    ├──► S3 (코드 다운로드)                       │
    ├──► Docker (코드 실행)                       │
    └──► Redis (결과 게시) ───────────────────────┘
```

## 리소스 요약

| 리소스 | 이름 | 위치 |
|--------|------|------|
| VPC | nanogrid-vpc | Region |
| Public Subnet | 10.0.1.0/24 | ap-northeast-2a |
| Private-App Subnet | 10.0.10.0/24 | ap-northeast-2a |
| Private-Data Subnet | 10.0.20.0/24 | ap-northeast-2a |
| S3 | nanogrid-code-bucket | Region (Multi-AZ) |
| SQS | nanogrid-task-queue | Region (Multi-AZ) |
| DynamoDB | NanoGridFunctions | Region (Multi-AZ) |
| ElastiCache | nanogrid-redis | Private-Data Subnet |
| Lambda | nanogrid-resource-manager | Private-App Subnet |
| Lambda | nanogrid-dispatcher | Private-App Subnet |
| EC2 ASG | nanogrid-worker-asg | Private-Data Subnet |
| API Gateway | nanogrid-api | Region |
